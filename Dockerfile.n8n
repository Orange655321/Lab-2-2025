FROM node:20-bullseye-slim

ENV N8N_VERSION=1.38.1
USER root
RUN apt-get update \
 && apt-get install -y --no-install-recommends ffmpeg python3 python3-pip build-essential tini \
 && npm install -g n8n@${N8N_VERSION} \
 && python3 -m pip install --no-cache-dir --upgrade pip \
 && python3 -m pip install --no-cache-dir torch==2.1.2+cpu --index-url https://download.pytorch.org/whl/cpu \
 && python3 -m pip install --no-cache-dir "numpy<2" \
 && python3 -m pip install --no-cache-dir openai-whisper==20231117 auto-subtitle==1.0.1 ffmpeg-python \
 && mkdir -p /home/node/.n8n /data/files \
 && chown -R node:node /home/node /data/files \
 && rm -rf /var/lib/apt/lists/*
USER node
WORKDIR /home/node
ENV PATH="/home/node/.local/bin:${PATH}"
ENTRYPOINT ["tini","--"]
CMD ["n8n"]
